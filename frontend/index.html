<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台科大健康任務地圖</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .user-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .user-stat {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.1em;
        }

        .user-stat strong {
            font-size: 1.5em;
            display: block;
            margin-top: 5px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .input-section {
            height: fit-content;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .points-preview {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .points-preview h3 {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .points-preview p {
            color: #666;
            font-size: 0.9em;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 10px;
        }

        .building-info {
            text-align: center;
        }

        .building-info strong {
            font-size: 1.2em;
            color: #667eea;
        }

        .unlocked-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: 600;
        }

        .unlocked {
            background: #d4edda;
            color: #155724;
        }

        .locked {
            background: #f8d7da;
            color: #721c24;
        }

        .challenges-grid {
            display: grid;
            gap: 15px;
        }

        .challenge-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .challenge-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .challenge-progress {
            background: white;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .challenge-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .challenge-reward {
            color: #28a745;
            font-weight: 600;
            margin-top: 10px;
        }

        .team-section {
            display: grid;
            gap: 15px;
        }

        .team-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #667eea;
        }

        .team-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .team-members {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .member-badge {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .team-progress {
            margin-top: 10px;
        }

        .team-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .team-stat-item {
            background: #f0f4ff;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .team-stat-item strong {
            display: block;
            color: #667eea;
            font-size: 1.5em;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 5px solid #28a745;
        }

        .notification.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 標題與使用者資訊 -->
        <div class="header">
            <h1>🏃 台科大健康任務地圖</h1>
            <p style="color: #666; font-size: 1.1em;">探索校園 · 累積健康點數 · 解鎖建築物</p>
            <div class="user-info">
                <div class="user-stat">
                    <span>當前使用者</span>
                    <strong id="userName">健康達人</strong>
                </div>
                <div class="user-stat">
                    <span>總點數</span>
                    <strong id="totalPoints">0</strong>
                </div>
                <div class="user-stat">
                    <span>已解鎖建築</span>
                    <strong id="unlockedCount">0 / 15</strong>
                </div>
            </div>
        </div>

        <!-- 主要內容區 -->
        <div class="main-grid">
            <!-- 左側：每日數據輸入 -->
            <div class="input-section">
                <div class="card">
                    <h2>📊 今日健康數據</h2>
                    <form id="dailyForm">
                        <div class="form-group">
                            <label>🚶 步數</label>
                            <input type="number" id="steps" placeholder="例如：8000" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>⏱️ 運動時間（分鐘）</label>
                            <input type="number" id="exercise" placeholder="例如：30" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>💧 喝水量（毫升）</label>
                            <input type="number" id="water" placeholder="例如：2000" min="0" required>
                        </div>
                        
                        <div class="points-preview">
                            <h3 id="previewPoints">0</h3>
                            <p>預估獲得點數</p>
                        </div>

                        <button type="submit" class="btn">🎯 提交今日數據</button>
                    </form>
                </div>
            </div>

            <!-- 右側：地圖 -->
            <div class="card">
                <h2>🗺️ 台科大校園探索地圖</h2>
                <div id="map"></div>
            </div>
        </div>

        <!-- 挑戰任務 -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>🏆 本週健康挑戰</h2>
            <div class="challenges-grid" id="challengesList"></div>
        </div>

        <!-- 團隊功能 -->
        <div class="card">
            <h2>👥 我的團隊</h2>
            <div class="team-section" id="teamSection"></div>
        </div>
    </div>

    <!-- 通知 -->
    <div class="notification" id="notification">
        <div id="notificationText"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==================== 資料設定 ====================
        const API_URL = 'http://localhost:5000'; // 後端 API 網址
        const userId = 1; // 當前使用者 ID

        // 台科大建築物資料（含座標）
        const buildingsData = [
            { id: 1, name: '國際大樓', points: 50, lat: 25.0135, lng: 121.5420, description: '國際事務中心' },
            { id: 2, name: '研揚大樓', points: 80, lat: 25.0128, lng: 121.5415, description: '研究生宿舍' },
            { id: 3, name: '體育館', points: 100, lat: 25.0140, lng: 121.5425, description: '運動健身場所' },
            { id: 4, name: '圖書館', points: 120, lat: 25.0133, lng: 121.5410, description: '學習資源中心' },
            { id: 5, name: '綜合研究大樓', points: 150, lat: 25.0125, lng: 121.5422, description: '研究實驗室' },
            { id: 6, name: 'IB大樓', points: 100, lat: 25.0138, lng: 121.5412, description: '國際大樓延伸' },
            { id: 7, name: 'TR大樓', points: 90, lat: 25.0130, lng: 121.5428, description: '教學研究大樓' },
            { id: 8, name: 'EE大樓', points: 110, lat: 25.0142, lng: 121.5418, description: '電機系館' },
            { id: 9, name: 'BA大樓', points: 95, lat: 25.0136, lng: 121.5408, description: '管理學院' },
            { id: 10, name: 'RB大樓', points: 130, lat: 25.0122, lng: 121.5430, description: '研發大樓' },
            { id: 11, name: '學生活動中心', points: 70, lat: 25.0145, lng: 121.5422, description: '社團活動空間' },
            { id: 12, name: '設計館', points: 140, lat: 25.0120, lng: 121.5435, description: '設計學院' },
            { id: 13, name: '材料科技館', points: 160, lat: 25.0115, lng: 121.5425, description: '材料研究中心' },
            { id: 14, name: '人文社會學院', points: 85, lat: 25.0148, lng: 121.5415, description: '人社學院' },
            { id: 15, name: '國際交流中心', points: 75, lat: 25.0126, lng: 121.5405, description: '交換生服務' }
        ];

        // 每週挑戰任務
        const challengesData = [
            { id: 1, title: '快走達人', description: '一週內完成 3 次快走，每次至少 20 分鐘', reward: 100, current: 0, target: 3 },
            { id: 2, title: '萬步勇士', description: '連續 5 天達到 10,000 步', reward: 150, current: 0, target: 5 },
            { id: 3, title: '水分補給王', description: '連續 7 天喝水量達到 2000ml', reward: 80, current: 0, target: 7 }
        ];

        // 團隊資料
        const teamsData = [
            { 
                id: 1, 
                name: '健康小隊', 
                members: ['小明', '小華', '小美', '健康達人'],
                totalPoints: 3500,
                teamTask: '團隊累計 50,000 步',
                currentProgress: 35000,
                targetProgress: 50000
            }
        ];

        // ==================== 狀態管理 ====================
        let userTotalPoints = 0;
        let unlockedBuildings = [];
        let userProgress = [];

        // ==================== 初始化地圖 ====================
        const NTUST_CENTER = [25.0132, 121.5418];
        const map = L.map('map').setView(NTUST_CENTER, 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 自訂標記圖示
        const unlockedIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const lockedIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // ==================== 點數計算邏輯 ====================
        function calculatePoints(steps, exercise, water) {
            let points = 0;
            
            // 步數點數 (每1000步 = 10點，超過10000步有額外獎勵)
            points += Math.floor(steps / 1000) * 10;
            if (steps >= 10000) points += 50; // 破萬獎勵
            if (steps >= 15000) points += 100; // 超級獎勵
            
            // 運動時間點數 (每10分鐘 = 15點，超過30分鐘有額外獎勵)
            points += Math.floor(exercise / 10) * 15;
            if (exercise >= 30) points += 30;
            if (exercise >= 60) points += 80;
            
            // 喝水量點數 (每500ml = 5點，達到2000ml有獎勵)
            points += Math.floor(water / 500) * 5;
            if (water >= 2000) points += 25;
            if (water >= 3000) points += 50;
            
            return points;
        }

        // ==================== 即時預覽點數 ====================
        document.getElementById('steps').addEventListener('input', updatePreview);
        document.getElementById('exercise').addEventListener('input', updatePreview);
        document.getElementById('water').addEventListener('input', updatePreview);

        function updatePreview() {
            const steps = parseInt(document.getElementById('steps').value) || 0;
            const exercise = parseInt(document.getElementById('exercise').value) || 0;
            const water = parseInt(document.getElementById('water').value) || 0;
            
            const points = calculatePoints(steps, exercise, water);
            document.getElementById('previewPoints').textContent = points;
        }

        // ==================== 提交每日數據 ====================
        document.getElementById('dailyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const steps = parseInt(document.getElementById('steps').value);
            const exercise = parseInt(document.getElementById('exercise').value);
            const water = parseInt(document.getElementById('water').value);
            const points = calculatePoints(steps, exercise, water);
            
            // 更新總點數
            userTotalPoints += points;
            
            // 檢查是否可以解鎖新建築
            checkUnlockBuildings();
            
            // 更新挑戰進度
            updateChallenges(steps, exercise, water);
            
            // 顯示通知
            showNotification(`🎉 太棒了！今日獲得 ${points} 點！總點數：${userTotalPoints}`);
            
            // 重置表單
            document.getElementById('dailyForm').reset();
            updatePreview();
            
            // 更新顯示
            updateUI();
            
            // 可選：發送到後端
            try {
                await fetch(`${API_URL}/upload_data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        date: new Date().toISOString().split('T')[0],
                        steps, exercise_minutes: exercise, water_ml: water,
                        points_earned: points
                    })
                });
            } catch (error) {
                console.log('後端未連接，使用本地資料');
            }
        });

        // ==================== 檢查建築物解鎖 ====================
        function checkUnlockBuildings() {
            buildingsData.forEach(building => {
                if (!unlockedBuildings.includes(building.id) && userTotalPoints >= building.points) {
                    unlockedBuildings.push(building.id);
                    showNotification(`🎊 恭喜解鎖新建築：${building.name}！`);
                }
            });
        }

        // ==================== 更新挑戰進度 ====================
        function updateChallenges(steps, exercise, water) {
            // 快走達人
            if (exercise >= 20) {
                challengesData[0].current = Math.min(challengesData[0].current + 1, challengesData[0].target);
            }
            
            // 萬步勇士
            if (steps >= 10000) {
                challengesData[1].current = Math.min(challengesData[1].current + 1, challengesData[1].target);
            }
            
            // 水分補給王
            if (water >= 2000) {
                challengesData[2].current = Math.min(challengesData[2].current + 1, challengesData[2].target);
            }
            
            // 檢查是否完成挑戰
            challengesData.forEach(challenge => {
                if (challenge.current === challenge.target && !challenge.completed) {
                    challenge.completed = true;
                    userTotalPoints += challenge.reward;
                    showNotification(`🏆 完成挑戰「${challenge.title}」！獲得 ${challenge.reward} 點獎勵！`);
                }
            });
        }

        // ==================== 渲染地圖標記 ====================
        function renderMap() {
            buildingsData.forEach(building => {
                const isUnlocked = unlockedBuildings.includes(building.id);
                const icon = isUnlocked ? unlockedIcon : lockedIcon;
                
                const marker = L.marker([building.lat, building.lng], { icon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="building-info">
                            <strong>${building.name}</strong><br/>
                            <p style="margin: 10px 0;">${building.description}</p>
                            <p>🎯 解鎖點數：${building.points}</p>
                            <span class="unlocked-badge ${isUnlocked ? 'unlocked' : 'locked'}">
                                ${isUnlocked ? '✅ 已解鎖' : '🔒 未解鎖'}
                            </span>
                        </div>
                    `);
            });
        }

        // ==================== 渲染挑戰任務 ====================
        function renderChallenges() {
            const html = challengesData.map(challenge => {
                const progress = (challenge.current / challenge.target) * 100;
                return `
                    <div class="challenge-card">
                        <h3>${challenge.title}</h3>
                        <p>${challenge.description}</p>
                        <div class="challenge-progress">
                            <div class="challenge-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <p style="margin-top: 10px;">進度：${challenge.current} / ${challenge.target}</p>
                        <p class="challenge-reward">🎁 獎勵：${challenge.reward} 點</p>
                        ${challenge.completed ? '<p style="color: #28a745; font-weight: 600;">✅ 已完成</p>' : ''}
                    </div>
                `;
            }).join('');
            document.getElementById('challengesList').innerHTML = html;
        }

        // ==================== 渲染團隊 ====================
        function renderTeams() {
            const html = teamsData.map(team => {
                const progress = (team.currentProgress / team.targetProgress) * 100;
                return `
                    <div class="team-card">
                        <h3>👥 ${team.name}</h3>
                        <div class="team-members">
                            ${team.members.map(m => `<span class="member-badge">${m}</span>`).join('')}
                        </div>
                        <div class="team-progress">
                            <strong>團隊任務：${team.teamTask}</strong>
                            <div class="challenge-progress" style="margin: 10px 0;">
                                <div class="challenge-progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <p>進度：${team.currentProgress.toLocaleString()} / ${team.targetProgress.toLocaleString()}</p>
                        </div>
                        <div class="team-stats">
                            <div class="team-stat-item">
                                <strong>${team.totalPoints}</strong>
                                <span>團隊總點數</span>
                            </div>
                            <div class="team-stat-item">
                                <strong>${team.members.length}</strong>
                                <span>成員數</span>
                            </div>
                            <div class="team-stat-item">
                                <strong>${Math.floor(progress)}%</strong>
                                <span>任務進度</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('teamSection').innerHTML = html;
        }

        // ==================== 更新 UI ====================
        function updateUI() {
            document.getElementById('totalPoints').textContent = userTotalPoints;
            document.getElementById('unlockedCount').textContent = `${unlockedBuildings.length} / ${buildingsData.length}`;
            renderChallenges();
            
            // 重新渲染地圖標記
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            renderMap();
        }

        // ==================== 通知系統 ====================
        function showNotification(text) {
            const notification = document.getElementById('notification');
            document.getElementById('notificationText').textContent = text;
            notification.classList.add('show', 'success');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ==================== 初始化 ====================
        window.addEventListener('load', () => {
            renderMap();
            renderChallenges();
            renderTeams();
            updateUI();
        });
    </script>
</body>
</html>