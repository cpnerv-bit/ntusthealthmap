<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>台科大健康任務地圖</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      #map {
        width: 100%;
        height: 500px;
        border-bottom: 3px solid #667eea;
      }

      .progress-section {
        padding: 30px;
        background: #f8f9fa;
      }

      .progress-section h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 1.8em;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      }

      .stat-card h3 {
        color: #667eea;
        font-size: 2em;
        margin-bottom: 5px;
      }

      .stat-card p {
        color: #666;
        font-size: 0.9em;
      }

      .progress-list {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }

      .progress-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .progress-item:last-child {
        border-bottom: none;
      }

      .progress-item .date {
        font-weight: bold;
        color: #667eea;
      }

      .progress-item .details {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .detail-badge {
        background: #667eea;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.85em;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.2em;
      }

      .error {
        background: #fee;
        color: #c33;
        padding: 15px;
        border-radius: 10px;
        margin: 20px;
        text-align: center;
      }

      .unlocked {
        color: #28a745 !important;
        font-weight: bold;
      }

      .locked {
        color: #dc3545 !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🏃 台科大健康任務地圖</h1>
        <p>探索校園 · 累積健康點數 · 解鎖建築物</p>
      </div>
      
      <div id="map"></div>
      
      <div class="progress-section">
        <h2>📊 探索進度</h2>
        <div class="stats-grid" id="statsGrid"></div>
        <div class="progress-list" id="progressList"></div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // 台科大座標
      const NTUST_CENTER = [25.0132, 121.5418];
      const userId = 1; // 範例用戶ID
      
      // 後端 API 網址（請改成您的實際網址）
      const API_URL = 'http://localhost:5000';

      // 初始化地圖
      const map = L.map('map').setView(NTUST_CENTER, 17);

      // 加入 OpenStreetMap 圖層
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      // 自訂標記圖示
      const unlockedIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      const lockedIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      // 載入資料
      async function loadData() {
        try {
          // 模擬資料（因為後端可能還沒啟動）
          const mockBuildings = [
            { id: 1, name: '國際大樓', description: '台科大國際事務中心', points_required: 100, latitude: 25.0135, longitude: 121.5420 },
            { id: 2, name: '研揚大樓', description: '研究生宿舍', points_required: 200, latitude: 25.0128, longitude: 121.5415 },
            { id: 3, name: '體育館', description: '運動健身場所', points_required: 150, latitude: 25.0140, longitude: 121.5425 }
          ];

          const mockProgress = [
            { id: 1, user_id: 1, date: '2025-10-01', steps: 8500, exercise_minutes: 45, water_ml: 2000, points_earned: 85, unlocked_building_id: 1 },
            { id: 2, user_id: 1, date: '2025-10-02', steps: 12000, exercise_minutes: 60, water_ml: 2500, points_earned: 120, unlocked_building_id: 2 }
          ];

          // 嘗試從真實 API 載入，失敗則使用模擬資料
          let buildings = mockBuildings;
          let progress = mockProgress;

          try {
            const buildingsRes = await fetch(`${API_URL}/buildings`);
            const progressRes = await fetch(`${API_URL}/progress/${userId}`);
            
            if (buildingsRes.ok) {
              const data = await buildingsRes.json();
              buildings = data.buildings;
            }
            
            if (progressRes.ok) {
              const data = await progressRes.json();
              progress = data.progress;
            }
          } catch (error) {
            console.log('使用模擬資料（後端未連接）');
          }

          // 取得已解鎖建築物 ID
          const unlockedIds = progress
            .filter(p => p.unlocked_building_id)
            .map(p => p.unlocked_building_id);

          // 在地圖上標記建築物
          buildings.forEach(building => {
            const isUnlocked = unlockedIds.includes(building.id);
            const icon = isUnlocked ? unlockedIcon : lockedIcon;
            
            const marker = L.marker([building.latitude, building.longitude], { icon })
              .addTo(map)
              .bindPopup(`
                <div style="text-align: center;">
                  <strong style="font-size: 1.1em;">${building.name}</strong><br/>
                  <p style="margin: 10px 0;">${building.description}</p>
                  <p>解鎖點數：${building.points_required}</p>
                  <p class="${isUnlocked ? 'unlocked' : 'locked'}">
                    ${isUnlocked ? '✅ 已解鎖' : '🔒 未解鎖'}
                  </p>
                </div>
              `);
          });

          // 顯示統計資料
          displayStats(progress);
          
          // 顯示進度列表
          displayProgress(progress);

        } catch (error) {
          console.error('載入資料失敗:', error);
          document.getElementById('progressList').innerHTML = 
            '<div class="error">無法載入資料，請確認後端服務是否啟動</div>';
        }
      }

      // 顯示統計資料
      function displayStats(progress) {
        const totalSteps = progress.reduce((sum, p) => sum + (p.steps || 0), 0);
        const totalExercise = progress.reduce((sum, p) => sum + (p.exercise_minutes || 0), 0);
        const totalWater = progress.reduce((sum, p) => sum + (p.water_ml || 0), 0);
        const totalPoints = progress.reduce((sum, p) => sum + (p.points_earned || 0), 0);

        document.getElementById('statsGrid').innerHTML = `
          <div class="stat-card">
            <h3>${totalSteps.toLocaleString()}</h3>
            <p>總步數</p>
          </div>
          <div class="stat-card">
            <h3>${totalExercise}</h3>
            <p>運動分鐘</p>
          </div>
          <div class="stat-card">
            <h3>${totalWater}</h3>
            <p>喝水 (ml)</p>
          </div>
          <div class="stat-card">
            <h3>${totalPoints}</h3>
            <p>累積點數</p>
          </div>
        `;
      }

      // 顯示進度列表
      function displayProgress(progress) {
        const html = progress.map(p => `
          <div class="progress-item">
            <span class="date">📅 ${p.date}</span>
            <div class="details">
              <span class="detail-badge">🚶 ${p.steps || 0} 步</span>
              <span class="detail-badge">🏃 ${p.exercise_minutes || 0} 分鐘</span>
              <span class="detail-badge">💧 ${p.water_ml || 0} ml</span>
              <span class="detail-badge">⭐ +${p.points_earned || 0} 點</span>
            </div>
          </div>
        `).join('');

        document.getElementById('progressList').innerHTML = html || 
          '<div class="loading">暫無進度記錄</div>';
      }

      // 頁面載入時執行
      window.addEventListener('load', loadData);
    </script>
  </body>
</html>